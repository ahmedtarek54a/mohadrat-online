<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محاضرات أونلاين — Forum</title>
    <link rel="icon" href="channels4_profile.jpg" type="image/jpeg">

  <link rel="stylesheet" href="style.css" />
</head>

<body>


  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html"><span class="brand-text">محاضرات أونلاين</span></a>
      <nav class="nav">
        <button id="menu-btn" class="menu-btn" aria-label="Open menu">☰</button>
        <ul class="nav-list" id="nav-list">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="courses.html">Courses</a></li>
          <li><a href="forum.html">Forum</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container section">
    <h1>Discussion Forum</h1>
    <p class="lead">Ask questions and discuss topics with peers. Comments are saved in your browser (LocalStorage).</p>

    <div class="forum-area">
      <form id="comment-form">
        <label for="comment">Write a question or reply</label>
        <textarea id="comment" rows="4" placeholder="Type your message..."></textarea>
        <div class="form-actions">
          <button type="submit" class="btn primary">Post</button>
          <button type="button" id="clear-btn" class="btn ghost">Clear All</button>
        </div>
      </form>

      <ul id="comments-list" class="comments-list" aria-live="polite"></ul>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer small-footer">
    <div class="container footer-inner">
      <div class="footer-col">
        <h3>Mohadrat Online</h3>
      </div>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    if (window.location.protocol === 'file:') {
      alert('Attention: You are opening this file directly. The Forum and Login features will NOT work properly. Please use the Local Server URL (usually http://localhost:3001) as per the instructions.');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const commentForm = document.getElementById('comment-form');
      const commentsList = document.getElementById('comments-list');
      const clearBtn = document.getElementById('clear-btn'); // Note: Clear All is less useful in server mode, maybe hide or change behavior to refresh? keeping for now but removing listener to avoid accidental wipe

      if (clearBtn) clearBtn.style.display = 'none'; // Hide clear all for now

      const currentUser = JSON.parse(localStorage.getItem('edu_user_data') || 'null');

      // Load Posts
      async function loadPosts() {
        try {
          const res = await fetch('/api/forum');
          const posts = await res.json();
          renderPosts(posts);
        } catch (err) {
          console.error(err);
          commentsList.innerHTML = `<li style="color: red; text-align: center; padding: 20px;">
              <strong>Error connecting to database.</strong><br>
              Please make sure the server is running (run_server.bat).<br>
              If you just updated the code, please RESTART the server.
          </li>`;
        }
      }

      // Render Posts
      function renderPosts(posts) {
        commentsList.innerHTML = '';
        if (posts.length === 0) {
          commentsList.innerHTML = '<li class="no-comments">No discussions yet. Be the first!</li>';
          return;
        }

        posts.forEach(post => {
          const li = document.createElement('li');
          li.className = 'comment-item';

          // Determine permissions
          const isAuthor = currentUser && currentUser.name === post.author;
          const isAdmin = currentUser && currentUser.role === 'admin';

          let controls = '';
          if (isAuthor || isAdmin) {
            controls += `<div style="float:right;">`;
            if (isAuthor) {
              controls += `<button class="btn ghost small" onclick="editPost('${post.id}')" style="margin-right:5px; color:blue;">Edit</button>`;
            }
            controls += `<button class="btn ghost small" onclick="deletePost('${post.id}')" style="color:red;">Delete</button>`;
            controls += `</div>`;
          }

          // Replies HTML
          let repliesHtml = '';
          if (post.replies && post.replies.length > 0) {
            repliesHtml = '<ul class="replies-list">';
            post.replies.forEach(reply => {
              const isReplyAuthor = currentUser && currentUser.name === reply.author;
              let replyControls = '';
              if (isAdmin || isReplyAuthor) {
                replyControls = `<button class="btn ghost small" onclick="deleteReply('${post.id}', '${reply.id}')" style="color:red; float:right; font-size:0.8em; margin-left: 10px;">Delete</button>`;
              }

              repliesHtml += `
                            <li class="reply-item" style="border-top:1px solid #eee; padding-top:10px; margin-top:10px; margin-left: 20px; overflow:hidden;">
                                ${replyControls}
                                <strong>${escapeHtml(reply.author)}</strong> <small>${new Date(reply.timestamp).toLocaleString()}</small>
                                <p>${escapeHtml(reply.content)}</p>
                            </li>
                        `;
            });
            repliesHtml += '</ul>';
          }

          li.innerHTML = `
                    <div class="post-content" id="post-content-${post.id}">
                        ${controls}
                        <div class="comment-author"><strong>${escapeHtml(post.author)}</strong> <span class="comment-date">${new Date(post.timestamp).toLocaleString()}</span></div>
                        <p class="comment-text" id="text-${post.id}">${escapeHtml(post.content)}</p>
                        
                        <div class="post-actions" style="margin-top:10px;">
                            <button class="btn small ghost" onclick="showReplyForm('${post.id}')">Reply</button>
                        </div>

                        <!-- Edit Form (Hidden by default) -->
                        <div id="edit-form-${post.id}" class="edit-form-container" style="display:none; margin-top:10px; border:1px solid #ddd; padding:10px; border-radius:5px;">
                            <textarea id="edit-text-${post.id}" rows="3" style="width:100%; margin-bottom:5px;">${escapeHtml(post.content)}</textarea>
                            <div>
                                <button class="btn small primary" onclick="saveEdit('${post.id}')">Save</button>
                                <button class="btn small ghost" onclick="cancelEdit('${post.id}')">Cancel</button>
                            </div>
                        </div>

                        <!-- Reply Form (Hidden by default) -->
                        <div id="reply-form-${post.id}" class="reply-form-container" style="display:none; margin-top:10px;">
                            <textarea id="reply-text-${post.id}" rows="2" placeholder="Write a reply..." style="width:100%; margin-bottom:5px;"></textarea>
                            <button class="btn small primary" onclick="submitReply('${post.id}')">Submit Reply</button>
                        </div>

                        ${repliesHtml}
                    </div>
                `;
          commentsList.appendChild(li);
        });
      }

      // Helper to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Submit New Post
      commentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return alert('Please login first to post!');

        const text = document.getElementById('comment').value;
        if (!text.trim()) return;

        try {
          const res = await fetch('/api/forum', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              author: currentUser.name,
              content: text
            })
          });

          if (res.ok) {
            document.getElementById('comment').value = '';
            loadPosts();
          } else {
            alert('Error posting comment');
          }
        } catch (err) {
          console.error(err);
        }
      });

      // Global functions for inline onclick handlers
      window.showReplyForm = (postId) => {
        if (!currentUser) return alert('Please login first to reply!');
        const form = document.getElementById(`reply-form-${postId}`);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
      };

      window.submitReply = async (postId) => {
        const text = document.getElementById(`reply-text-${postId}`).value;
        if (!text.trim()) return;

        try {
          const res = await fetch(`/api/forum/${postId}/replies`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              author: currentUser.name,
              content: text
            })
          });

          if (res.ok) {
            loadPosts();
          } else {
            alert('Error adding reply');
          }
        } catch (err) {
          console.error(err);
        }
      };

      window.deletePost = async (postId) => {
        if (!confirm('Are you sure you want to delete this post?')) return;
        try {
          const res = await fetch(`/api/forum/${postId}`, { method: 'DELETE' });
          if (res.ok) loadPosts();
          else alert('Failed to delete');
        } catch (err) {
          console.error(err);
        }
      };

      window.deleteReply = async (postId, replyId) => {
        if (!confirm('Are you sure you want to delete this reply?')) return;
        try {
          const res = await fetch(`/api/forum/${postId}/replies/${replyId}`, { method: 'DELETE' });
          if (res.ok) loadPosts();
          else alert('Failed to delete reply');
        } catch (err) {
          console.error(err);
        }
      };

      // Edit functions
      window.editPost = (postId) => {
        document.getElementById(`edit-form-${postId}`).style.display = 'block';
        document.getElementById(`text-${postId}`).style.display = 'none';
        // Also hide actions to clean up UI
        // document.querySelector(`#post-content-${postId} .post-actions`).style.display = 'none';
      };

      window.cancelEdit = (postId) => {
        document.getElementById(`edit-form-${postId}`).style.display = 'none';
        document.getElementById(`text-${postId}`).style.display = 'block';
      };

      window.saveEdit = async (postId) => {
        const newContent = document.getElementById(`edit-text-${postId}`).value;
        if (!newContent.trim()) return alert('Content cannot be empty');

        try {
          const res = await fetch(`/api/forum/${postId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newContent })
          });
          if (res.ok) {
            loadPosts();
          } else {
            alert('Error updating post');
          }
        } catch (err) {
          console.error(err);
          alert('Error connecting to server');
        }
      };

      // Initial Load
      loadPosts();
    });
  </script>
</body>

</html>